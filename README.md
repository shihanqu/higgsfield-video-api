# Higgsfield API Service

Этот проект представляет собой веб-сервис для работы с Higgsfield API, предоставляющий функциональность для создания и управления задачами генерации видео из изображений.

## Технологии

- **Python 3**
- **FastAPI**: Современный веб-фреймворк для создания API.
- **Uvicorn**: ASGI-сервер для запуска FastAPI.
- **Tortoise ORM**: Асинхронная ORM для работы с базой данных.
- **APScheduler**: Планировщик задач для асинхронной обработки.
- **Docker & Docker Compose**: Для контейнеризации и управления сервисами.
- **Pytest**: Для автоматизированного тестирования.

## Структура проекта

```
.
├── docker-compose.yaml      # Файл для оркестрации сервисов
├── post-merge               # Git hook для автоматического тестирования
├── higgsfield-api/          # Основная директория приложения
│   ├── Dockerfile             # Dockerfile для сборки образа
│   ├── pytest.ini             # Конфигурация pytest
│   ├── requirements/          # Зависимости проекта
│   │   └── base.txt
│   ├── src/                   # Исходный код
│   │   ├── main.py            # Точка входа в приложение FastAPI
│   │   ├── app_factory.py     # Фабрика приложения
│   │   ├── config.py          # Конфигурация и настройки
│   │   ├── endpoints/         # API эндпоинты
│   │   │   ├── auth/          # Аутентификация
│   │   │   ├── higgsfield/    # Эндпоинты Higgsfield
│   │   │   └── routes.py      # Маршрутизация
│   │   ├── repository/        # Работа с базой данных
│   │   │   ├── models/        # Модели данных
│   │   │   └── core.py        # Инициализация БД
│   │   ├── services/          # Бизнес-логика
│   │   ├── schedulers/        # Планировщики задач
│   │   └── utils/             # Утилиты
│   └── tests/                 # Автоматизированные тесты
└── README.md                # Этот файл
```

## Как запустить

Проект разработан для запуска в Docker-контейнерах.

1. **Склонируйте репозиторий:**
   ```bash
   git clone <URL репозитория>
   cd hf
   ```

2. **Создайте файл `.env`** в корневой директории проекта:
   ```env
   DB_HOST=localhost
   DB_SOCKET=/path/to/socket
   DB_USER=your_db_user
   DB_PASSWORD=your_db_password
   DB_NAME=your_db_name
   UUID_TEST_CHECK=your-secret-uuid
   ```

3. **Запустите сервисы с помощью Docker Compose:**
   Эта команда соберет Docker-образ и запустит контейнеры в фоновом режиме.
   ```bash
   docker-compose up -d --build
   ```
   Если образ уже собран, можно использовать:
   ```bash
   docker-compose up -d
   ```

4. Сервис будет доступен по адресу `http://localhost:8018`.

## API

### Аутентификация

#### Регистрация
- **URL**: `/api/auth/registration`
- **Метод**: `POST`
- **Описание**: Регистрация нового клиента (требует админ-токен).

#### Вход
- **URL**: `/api/auth/login`
- **Метод**: `POST`
- **Описание**: Аутентификация существующего клиента и получение токена.

### Генерация видео

#### Создание задачи генерации видео
- **URL**: `/api/higgsfield/i2v/`
- **Метод**: `POST`
- **Описание**: Создает задачу для генерации видео из изображения.
- **Заголовки**:
  - `X-API-KEY`: API токен клиента
- **Параметры формы**:
  - `image`: Файл изображения
  - `prompt`: Опциональный промпт для видео
  - `motion`: Тип движения (GENERAL, DISINTEGRATION, и т.д.)
  - `model`: Модель (lite, standard, turbo)
  - `duration`: Длительность видео (3 или 5 секунд)
  - `metadata`: Дополнительные метаданные в формате JSON

### Проверка состояния сервиса (Health Check)

- **URL**: `/health/{uuid}`
- **Метод**: `GET`
- **Описание**: Проверяет, работает ли сервис.
- **Параметры пути**:
  - `uuid` (string): Секретный UUID, указанный в `.env` файле (`UUID_TEST_CHECK`).

## Тестирование

Для запуска тестов выполните следующую команду:

```bash
docker-compose run --rm test
```

Эта команда запустит отдельный контейнер, который выполнит тесты с помощью `pytest` и затем будет удален.

